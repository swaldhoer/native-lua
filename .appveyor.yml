version: 5.3.5.{build}

image:
  - Visual Studio 2017
  - Ubuntu

skip_commits:
  files:
    - .vscode/*
    - .github/*
    - .cirrus.yml
    - .editorconfig
    - .travis.yml
    - azure-pipelines.yml

init:
  - git config --global core.autocrlf input

install:
  - ps: |
      if ($isWindows) {
        $rmpath = "Docker", "SQL", "Mercurial", "Subversion", "Maven", "CMake"
        $rmpath += "nodejs", "nunit", "nuget", "java", "xunit", "go", "python"
        $rmpath += "Amazon", "ruby", "perl", "Azur", "Webdriver", "Coverity"
        $rmpath += "Octopus", "erl9", "dotnet", "iojs", "Yarn"
        $rmpath += "npm", "Windows Performance Toolkit"
        $rmpath += "Microsoft Service Fabric", "Microsoft DNX"
        $rmpath += "Microsoft Visual Studio"
        $rmpath += "ServiceFabricLocalClusterManager"
        foreach ($i in $rmpath) {
          $env:path = ($env:path -split ";").Where({!($_ -like "*$i*")}) -join ";"
        }
      }
  - cmd: pushd "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\" && call "VC\Auxiliary\Build\vcvars64.bat" && popd
  - cmd: set PATH=C:\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\mingw64\bin;%PATH%
  - cmd: set PATH=C:\Python37-x64;C:\Python37-x64\Scripts;%PATH%
  - ps: |
      if ($isWindows) {
        Write-Host New `$env:Path
        Write-Host ($env:Path).Replace(';',"`n")
        }
  - cmd: python -m pip install --upgrade pip -q
  - cmd: python -m pip install pylint black sphinx pyyaml -q
  - sh: sudo apt-get update
  - sh: sudo apt-get install python3-pip -y
  - sh: sudo python3 -m pip install sphinx -q
  - cmd: mkdir C:\download && mkdir C:\download\doxygen
  - cmd: cd C:\download\doxygen" && curl -o doxygen-x64.zip http://doxygen.nl/files/doxygen-1.8.16.windows.x64.bin.zip
  - cmd: cd C:\download\doxygen" && tar -xvzf doxygen-x64.zip
  - cmd: set PATH=C:\download\doxygen;%PATH%
  - sh: sudo apt-get install doxygen graphviz -y
  - doxygen -v
  - cmd: python --version
  - sh: python3 --version
  - cmd: black --version
  - cmd: pylint --version
  - clang --version
  - gcc --version
  - cmd: cl

  # setup cygwin64
  - cmd: curl -o setup-x86_64.exe http://www.cygwin.com/setup-x86_64.exe
  - cmd: setup-x86_64.exe --no-desktop --no-shortcuts --no-startmenu --quiet-mode --packages wget python37 python37-pip
  - cmd: C:\cygwin64\bin\bash.exe -l -c "python3 --version"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "python3 -m ensurepip --upgrade"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "git clone https://github.com/sphinx-doc/sphinx && cd sphinx && pip3 install ."
  - cmd: C:\cygwin64\bin\bash.exe -l -c "wget https://github.com/yaml/pyyaml/archive/5.1.2.tar.gz && tar -xvf 5.1.2.tar.gz && cd pyyaml-5.1.2 && python3 setup.py install"
  # for testing
  - cmd: set PATH=%PATH%;%userprofile%\AppData\Local\Programs\lua\bin

before_build:
  # check that the correct python versions are used
  - cmd: python waf --help
  - sh: python3 waf --help
  # ensure that only well formated wscripts are checked in
  - cmd: black . --config=pyproject.toml --check -v
  - cmd: pylint wscript
  - cmd: pylint scripts\\run_test.py
  - cmd: pylint scripts\\sphinx.py
  - cmd: pylint scripts\\utils.py

build_script:
  # basic configuration
  - cmd: python waf configure
  - sh: python3 waf configure
  # check documentation build
  - cmd: python waf build_docs -v
  - sh: python3 waf build_docs -v
  - cmd: python waf clean_docs
  - sh: python3 waf clean_docs
  - cmd: python waf distclean
  - sh: python3 waf distclean
  # configure including the test files
  - cmd: python waf configure --include-tests
  - sh: python3 waf configure --include-tests
  # msvc
  - cmd: python waf build_msvc
  - cmd: python waf install_msvc
  - cmd: cd build/msvc/tests
  - cmd: lua -e"_U=true" all.lua
  # - cmd: lua all.lua
  - cmd: cd ../../..
  - cmd: python waf uninstall_msvc
  - cmd: python waf clean_msvc
  # gcc
  - cmd: python waf build_gcc
  - sh: python3 waf build_gcc
  - cmd: python waf install_gcc
  - sh: sudo python3 waf install_gcc
  - cd build/gcc/tests
  - lua -e"_U=true" all.lua
  #- sh: lua all.lua
  - cd ../../..
  - cmd: python waf uninstall_gcc
  - sh: sudo python3 waf uninstall_gcc
  - cmd: python waf clean_gcc
  - sh: python3 waf clean_gcc
  # clang
  - cmd: python waf build_clang
  - sh: python3 waf build_clang
  - cmd: python waf install_clang
  - sh: sudo python3 waf install_clang
  - cd build/clang/tests
  - lua -e"_U=true" all.lua
  #- sh: lua all.lua
  - cd ../../..
  - cmd: python waf uninstall_clang
  - sh: sudo python3 waf uninstall_clang
  - cmd: python waf clean_clang
  - sh: python3 waf clean_clang
  - cmd: python waf distclean
  - sh: python3 waf distclean
  - git clean -xdf
  # cygwin gcc
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf distclean configure --include-tests"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf build_docs"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf build_gcc"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf install_gcc"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua/build/gcc/tests && which lua && lua -v && lua -e\"_U=true\" all.lua"
  #- cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua/build/gcc/tests && which lua && lua -v && lua all.lua"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf uninstall_gcc"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf distclean"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 scripts/run_test.py -c gcc --simple-test"
  # configure including the test files and the ltests
  - cmd: python waf configure --include-tests --ltests
  - sh: python3 waf configure --include-tests --ltests
  # msvc
  - cmd: python waf build_msvc
  - cmd: python waf install_msvc
  - cmd: cd build/msvc/tests
  - cmd: lua -e"_U=true" all.lua
  # - cmd: lua all.lua
  - cmd: cd ../../..
  - cmd: python waf uninstall_msvc
  - cmd: python waf clean_msvc
  # gcc
  - cmd: python waf build_gcc
  - sh: python3 waf build_gcc
  - cmd: python waf install_gcc
  - sh: sudo python3 waf install_gcc
  - cd build/gcc/tests
  - lua -e"_U=true" all.lua
  #- sh: lua all.lua
  - cd ../../..
  - cmd: python waf uninstall_gcc
  - sh: sudo python3 waf uninstall_gcc
  - cmd: python waf clean_gcc
  - sh: python3 waf clean_gcc
  # clang
  - cmd: python waf build_clang
  - sh: python3 waf build_clang
  - cmd: python waf install_clang
  - sh: sudo python3 waf install_clang
  - cd build/clang/tests
  - lua -e"_U=true" all.lua
  #- sh: lua all.lua
  - cd ../../..
  - cmd: python waf uninstall_clang
  - sh: sudo python3 waf uninstall_clang
  - cmd: python waf clean_clang
  - sh: python3 waf clean_clang
  - cmd: python waf distclean
  - sh: python3 waf distclean
  - git clean -xdf
  - cmd: python scripts\run_test.py -c msvc -c gcc -c clang --simple-test
  - sh: python3 scripts/run_test.py -c gcc -c clang --simple-test
  - cmd: python scripts\run_test.py -c msvc -c gcc -c clang --simple-test --ltests
  - sh: python3 scripts/run_test.py -c gcc -c clang --simple-test --ltests
  - git clean -xdf
  # cygwin gcc
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf distclean configure --include-tests"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf build_docs"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf build_gcc"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf install_gcc"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua/build/gcc/tests && which lua && lua -v && lua -e\"_U=true\" all.lua"
  #- cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua/build/gcc/tests && which lua && lua -v && lua all.lua"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf uninstall_gcc"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 waf distclean"
  - cmd: C:\cygwin64\bin\bash.exe -l -c "cd /cygdrive/c/projects/native-lua && python3 scripts/run_test.py -c gcc --simple-test"
