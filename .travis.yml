branches:
  except:
    - /^appveyor-.*$/
    - /^azure.*$/
    - /^cirrus-ci.*$/

env:
  - NATIVE_LUA_CI_BUILD="TRUE"

addons:
  apt:
    update: true
    packages:
      - doxygen
      - graphviz

cache: pip

matrix:
  fast_finish: true
  include:
    - os: linux
      dist: xenial
      language: python
      sudo: required
    - os: linux
      dist: bionic
      language: python
      sudo: required
    # - os: linux
    #   arch: ppc64le
    #   language: python
    #   sudo: required
    # - os: linux
    #   arch: s390x
    #   language: python
    #   sudo: required
    # - os: linux
    #   arch: arm64
    #   language: python
    #   sudo: required

install:
  - python3 -m pip install --upgrade --requirement requirements.txt
  # - if [ "$TRAVIS_CPU_ARCH" != "amd64" ]; then sudo apt-get install python3-pip -y; fi
  # - if [ "$TRAVIS_CPU_ARCH" != "amd64" ]; then sudo python3 -m pip install sphinx -q; fi

before_script:
  - which gcc
  - which clang
  - echo $PATH
  - python3 --version
  - gcc --version
  - clang --version
  - doxygen --version
  - sphinx-build --version

script:
  - python3 waf configure -vv
  # check documentation build
  - python3 waf build_docs
  - python3 waf clean_docs
  - python3 waf distclean
  - python3 waf configure --include-tests
  # gcc [
  - python3 waf build_gcc
  - sudo python3 waf install_gcc
  - pushd build/gcc/tests
  - lua -e"_U=true" all.lua
  - lua all.lua
  - popd
  - sudo python3 waf uninstall_gcc
  - python3 waf clean_gcc
  # gcc ]
  # clang [
  - python3 waf build_clang
  - sudo python3 waf install_clang
  - pushd build/clang/tests
  - lua -e"_U=true" all.lua
  - lua all.lua
  - popd
  - sudo python3 waf uninstall_clang
  - python3 waf clean_clang
  # clang ]
  - python3 waf distclean
  # including ltests
  - python3 waf configure --ltests --include-tests
  # gcc [
  - python3 waf build_gcc
  - sudo python3 waf install_gcc
  - pushd build/gcc/tests
  - lua -e"_U=true" all.lua
  - lua all.lua
  - popd
  - sudo python3 waf uninstall_gcc
  - python3 waf clean_gcc
  # gcc ]
  # clang [
  - python3 waf build_clang
  - sudo python3 waf install_clang
  - pushd build/clang/tests
  - lua -e"_U=true" all.lua
  - lua all.lua
  - popd
  - sudo python3 waf uninstall_clang
  - python3 waf clean_clang
  # clang ]
  - python3 waf distclean
  # test script
  - python3 scripts/run_test.py -c gcc -c clang --simple-test
  - python3 scripts/run_test.py -c gcc -c clang
  - python3 scripts/run_test.py -c gcc -c clang --simple-test --ltests
  - python3 scripts/run_test.py -c gcc -c clang --ltests
